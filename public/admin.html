<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BHR Admin Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-8 font-sans">

    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-red-500">
                <i class="fa-solid fa-lock mr-2"></i>Secure Admin
            </h1>
            <a href="/" class="text-gray-400 hover:text-white underline">Back to App</a>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="max-w-md mx-auto mt-20 p-8 bg-gray-800 rounded-xl border border-gray-700 shadow-2xl">
            <h2 class="text-xl font-bold mb-6 text-center">Authenticate</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold mb-1 text-gray-400 uppercase">Admin Password</label>
                    <input type="password" id="passwordInput" placeholder="••••••••" 
                        class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-3 focus:border-red-500 focus:outline-none transition-colors">
                </div>
                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded transition-colors">
                    Login
                </button>
            </form>
            <p id="loginError" class="text-red-500 text-center text-sm mt-4 hidden"></p>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Live Feed</h2>
                <button onclick="logout()" class="text-xs text-gray-400 hover:text-white uppercase font-bold">Logout</button>
            </div>
            <div class="bg-gray-800 rounded-lg overflow-hidden border border-gray-700 shadow-xl">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-900 text-gray-400 text-sm uppercase">
                            <th class="p-4 border-b border-gray-700">Place</th>
                            <th class="p-4 border-b border-gray-700">Content</th>
                            <th class="p-4 border-b border-gray-700 w-24">Votes</th>
                            <th class="p-4 border-b border-gray-700 w-24">Action</th>
                        </tr>
                    </thead>
                    <tbody id="reviewsTable" class="divide-y divide-gray-700"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/reviews';
        const AUTH_URL = '/api/admin/login';
        const loginSection = document.getElementById('loginSection');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');

        // Check for existing session on load
        const token = localStorage.getItem('adminToken');
        if (token) {
            showDashboard();
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;

            try {
                const res = await fetch(AUTH_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await res.json();

                if (res.ok) {
                    localStorage.setItem('adminToken', data.token);
                    showDashboard();
                    loginForm.reset();
                    loginError.classList.add('hidden');
                } else {
                    throw new Error(data.error || 'Login failed');
                }
            } catch (err) {
                loginError.innerText = err.message;
                loginError.classList.remove('hidden');
            }
        });

        function showDashboard() {
            loginSection.classList.add('hidden');
            dashboard.classList.remove('hidden');
            loadReviews();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            location.reload();
        }

        async function loadReviews() {
            try {
                const res = await fetch(API_URL);
                const reviews = await res.json();
                renderTable(reviews);
            } catch (err) {
                alert("Failed to load reviews.");
            }
        }

        function renderTable(reviews) {
            const tbody = document.getElementById('reviewsTable');
            tbody.innerHTML = '';

            if (reviews.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">No reviews found.</td></tr>';
                return;
            }

            reviews.forEach(r => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-700/50 transition-colors';
                tr.innerHTML = `
                    <td class="p-4 font-bold text-white">${r.title} <br><span class="text-xs text-gray-500 font-normal">${r.category}</span></td>
                    <td class="p-4 text-gray-300 text-sm truncate max-w-xs">${r.body.substring(0, 60)}...</td>
                    <td class="p-4 text-gray-400">${r.votes}</td>
                    <td class="p-4">
                        <button onclick="deleteReview('${r._id}')" class="bg-red-500/20 hover:bg-red-600 hover:text-white text-red-500 px-3 py-1.5 rounded text-xs font-bold transition-colors border border-red-500/30">
                            DELETE
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function deleteReview(id) {
            if(!confirm("Permanently delete this review?")) return;

            const token = localStorage.getItem('adminToken');

            try {
                const res = await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}` // The Badge!
                    }
                });

                if (res.ok) {
                    loadReviews();
                } else {
                    const data = await res.json();
                    alert(data.error || "Failed to delete. Token might be expired.");
                    if(res.status === 401) logout();
                }
            } catch (err) {
                alert("Server Error");
            }
        }
    </script>
</body>
</html>
